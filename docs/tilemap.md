# タイルマップシステム

## 概要

このプロジェクトでは、ゲームのマップデータをタイルマップ形式で管理しています。タイルマップは、ゲーム世界をグリッド状のタイルで表現するシステムで、マップエディタでの編集や、将来的な拡張性を考慮して設計されています。

## ファイル構成

- **`src/engine/tileMap.json`**: タイルマップデータを格納するJSONファイル
- **`src/engine/tileMapLoader.ts`**: タイルマップデータを読み込み、エンティティを生成するローダー
- **`src/types/tileMap.ts`**: タイルマップ関連の型定義

## タイルタイプ

タイルマップでは、各タイルを数値で表現します。以下のタイルタイプが定義されています：

| 値 | タイプ | 説明 |
|---|---|---|
| `0` | 空 | 何もない透過ブロック（プレイヤーが通過可能） |
| `1` | 地面 | プラットフォーム（プレイヤーが着地できる） |
| `2` | 敵 | 敵キャラクターの配置位置 |
| `3` | コイン | コインの配置位置 |
| `4` | スター | ゴール（スター）の配置位置 |
| `5` | プレイヤー初期位置 | プレイヤーの開始位置（現在は未使用） |

## JSONファイル構造

`tileMap.json`の構造は以下の通りです：

```json
{
  "map": {
    "width": 125,      // マップの幅（タイル数）
    "height": 15,      // マップの高さ（タイル数）
    "tileSize": 40,    // 1タイルのサイズ（ピクセル）
    "tiles": [         // タイルデータ（2次元配列）
      [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      // ... マップの高さ分の行が続く（各行が1次元配列）
    ]
  },
  "playerSpawn": {
    "tileX": 2,        // プレイヤーの初期X座標（タイル単位）
    "tileY": 14        // プレイヤーの初期Y座標（タイル単位）
  },
  "enemySpawns": [     // 敵の追加情報（速度など）
    {
      "id": "e1",
      "tileX": 15,
      "tileY": 14,
      "vel": { "x": -2, "y": 0 }
    }
  ],
  "coinSpawns": [      // コインの追加情報
    {
      "id": "c-0",
      "tileX": 12,
      "tileY": 11
    }
  ],
  "starSpawn": {       // スターの追加情報
    "id": "star-goal",
    "tileX": 120,
    "tileY": 14
  }
}
```

## 座標系

### タイル座標 vs ピクセル座標

- **タイル座標**: マップ上の位置をタイル単位で表現（例: `tileX: 15, tileY: 14`）
- **ピクセル座標**: 画面上の位置をピクセル単位で表現（例: `x: 600, y: 560`）

変換式：
```
pixelX = tileX * tileSize
pixelY = tileY * tileSize
```

### タイル配列のアクセス方法

`tiles`配列は2次元配列（`TileType[][]`）で、以下のようにアクセスします：

```typescript
const tile = tiles[y][x];
```

例：幅125、高さ15のマップで、タイル座標(15, 14)の場合：
```typescript
const tile = tiles[14][15];  // 14行目、15列目のタイル
```

**注意**: 1次元配列形式も後方互換性のためサポートされていますが、2次元配列形式を推奨します。1次元配列の場合は、`tileMapConverter.ts`の`convert1DTo2DTiles()`関数で2次元配列に変換されます。

## 位置情報とSpawnsの関係

タイルマップシステムでは、**位置情報はタイルマップから取得し、移動速度などの追加情報はSpawnsから参照**する設計になっています。

### 動作の流れ

1. **タイルマップの走査**: `tileMapLoader.ts`がタイルマップを走査し、タイルタイプ2（敵）、3（コイン）、4（スター）を検出
2. **位置情報の取得**: 検出したタイルの位置（`tileX, tileY`）からピクセル座標を計算
3. **Spawns情報の参照**: 同じ位置に対応するSpawns情報を検索し、速度などの追加情報を取得
4. **エンティティの生成**: 位置情報と追加情報を組み合わせてエンティティを生成

### 例：敵の生成

```typescript
// タイルマップ内でタイルタイプ2を検出（位置: tileX=15, tileY=14）
// → ピクセル座標を計算: x=600, y=560

// Spawnsから追加情報を取得
const spawnInfo = enemySpawnMap.get("15,14");
// → { id: "e1", vel: { x: -2, y: 0 } }

// エンティティを生成
enemy = {
  id: "e1",
  type: "ENEMY",
  pos: { x: 600, y: 560 },  // タイルマップから取得
  vel: { x: -2, y: 0 }      // Spawnsから取得
}
```

## マップエディタでの使用方法

将来的にマップエディタを実装する場合、以下の手順でマップを編集できます：

1. **タイルの配置**: タイルタイプ（0-5）を選択してマップ上に配置
2. **Spawns情報の設定**: 敵・コイン・スターの位置に、速度などの追加情報を設定
3. **JSONファイルの保存**: 編集したマップを`tileMap.json`に保存

### マップエディタの実装例（将来）

```typescript
// マップエディタでの操作
// 1. タイルタイプ2を位置(15, 14)に配置（2次元配列の場合）
tiles[14][15] = 2;

// 2. 敵のSpawns情報を追加
enemySpawns.push({
  id: "e1",
  tileX: 15,
  tileY: 14,
  vel: { x: -2, y: 0 }
});
```

## タイル配列の形式

`tiles`配列は2次元配列（`TileType[][]`）で、マップの各行が配列として表現されます。これにより、視覚的にマップの構造を把握しやすくなっています。

```json
"tiles": [
  [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  // ... 各行がマップの1行（Y座標）に対応
]
```

- `tiles[y]`: Y座標`y`の行（横方向のタイル配列）
- `tiles[y][x]`: 座標`(x, y)`のタイル値

## 型定義

タイルマップ関連の型定義は`src/types/tileMap.ts`にあります：

```typescript
export type TileType = 0 | 1 | 2 | 3 | 4 | 5;

export interface TileMapData {
  width: number;
  height: number;
  /** タイルマップデータ（2次元配列を推奨、1次元配列も後方互換性のためサポート） */
  tiles: TileType[] | TileType[][];
  tileSize: number;
}

export interface EntitySpawn {
  tileX: number;
  tileY: number;
  id: string;
  vel?: { x: number; y: number };
}

export interface TileMapDefinition {
  map: TileMapData;
  playerSpawn?: { tileX: number; tileY: number };
  enemySpawns?: EntitySpawn[];
  coinSpawns?: EntitySpawn[];
  starSpawn?: EntitySpawn;
}
```

## 実装の詳細

### タイルマップローダー

`tileMapLoader.ts`の`createEntitiesFromTileMap()`関数が、タイルマップデータからエンティティを生成します：

1. タイルマップを読み込む
2. タイル配列を2次元配列に変換（1次元配列の場合は`convert1DTo2DTiles()`で変換）
3. Spawns情報を位置でマップ化（高速検索のため）
4. タイルマップを走査してエンティティを生成（`tiles[y][x]`の形式でアクセス）
5. 各タイルタイプに応じて適切なエンティティを作成

### エンティティ生成の優先順位

- **位置情報**: タイルマップ内のタイルタイプから取得（優先）
- **追加情報**: Spawnsから取得（速度、IDなど）
- **デフォルト値**: Spawns情報がない場合はデフォルト値を使用

## 今後の拡張

- マップエディタの実装
- 複数のマップファイルのサポート
- タイルタイプの追加（罠、アイテムなど）
- レイヤーシステムの導入
